# Azure LogicApps samples for Video Indexer

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Start Here](#start-here)
- [Classify objects with BYO GPT4o](#classify-objects-with-byo-gpt4o)
- [Upload Video](#upload-video)

## Overview

This folder contains Azure LogicApp samples to automate Azure Video Indexer flows, each flow will demonstrate how to run one basic flow, all the flows can be modified to suite the specific buisness case and should be tested before moving to prodcution.
You can also view the video toturial on our [YouTube channel](https://www.youtube.com/watch?v=yMqJufR9Rfs)


## Prerequisites

Please ensure that you have the following prerequisites:

- Azure subscription with permissions to create Azure resources.
- Azure Video Indexer Account. The quickest way is using the Azure Portal using this tutorial [Create Video Indexer account](https://learn.microsoft.com/azure/azure-video-indexer/create-account-portal#use-the-azure-portal-to-create-an-azure-video-indexer-account).
- Azure [LogicApp](https://learn.microsoft.com/en-us/azure/logic-apps/quickstart-create-example-consumption-workflow).

## Start here

The following are the commun configuraitons for the sample LogicApps:

- Go to the LogicApp resource, expend the and _Development Tools_ select _Logic app code view_. Copy the sample code to code pane, click _Save_.
- Select _Logic app designer_, the code sample flow should apear in the designer.
- Click on _Parameters_, fill the following parameters **Note**: some of the flows requires additional parameters)
  - account_id: Azure Video Indexer account id.
  - account_name: Azure Video Indexer account name.
  - account_rg: Azure Video Indexer resource group name.
  - endpoint: the base URL to be used for API calls, this can either point to the cloud account https://api.videoindexer.ai/<account_region>, or to a Video Indexer Arc extention endpoint.
  - subscription_id: the subscription id for the Video Indexer account.
  
  You will also need to configure a Managed Identity, this for the "Get Access Token" HTTP action:

  - Expend the _Settings_ on the left pane and select _Identity_
  - Under _System assinged_ change the _status_ to "On" and click _Save_
  - Click on _Azure role assignments_
  - Click on _Add role assignment_, set scope to "resource group", select the Video Indexer account resource group and set the role to "contributor".
  - Click _Save_.

## Classify objects with BYO GPT4o

In this LogicApp flow sample, you will learn how to add aditional details on the cars detected in an indexed video, the sample leverage Video Indexer's [BYO capability](https://learn.microsoft.com/en-us/azure/azure-video-indexer/arc/azure-video-indexer-enabled-by-arc-bring-your-own-model-overview) and [detected objects](https://learn.microsoft.com/en-us/azure/azure-video-indexer/object-detection?tabs=webportal) in additon to Azure OpenAI.

Flow overview:
This sample iterates over the detected objects of type 'car', retrieve the tumbnail generated by Video Indexer and send it to GPT4o to retrieve additional information, this sample call Azure OpenAI GPT4o to get the details on the detected car, but can be changed with any other vision AI.
The response from GPT will be patched back to the Video object, and will can be viewed in Vidoe Indexer video page and searched using Video Indexer search experience.

Configure the flow:

- Create [Azure OpenAI GPT4o](https://learn.microsoft.com/en-us/azure/ai-services/openai/gpt-v-quickstart?tabs=image%2Ccommand-line&pivots=programming-language-studio) deployment.
  - Browse to [Azure OpenAI Studio](https://oai.azure.com/portal), click _Chat_, under _deployments_ select your deployment.
  - In the chat area, click _Code View_ and update the following LogicApp parameters:
    - GPT_endpoint: copy the endpoint URI.
    - GPT_deployment_name: the name of the deployed model.
    - GPT_appkey: copy the __API key__.
  - object_type: Set the object type that the flow will iterate on, for this sample, we will use 'car', additional options are listed [here](https://learn.microsoft.com/en-us/azure/azure-video-indexer/object-detection?tabs=webportal#supported-objects).
  - prompt: the prompt that will be sent to GPT, for this sample we will use: "Identify and classify the car in the image. Classify the car in less than four words."
- LogicApp Tigger: This LogicApp flow use an HTTP trigger that listens to POST requests, you can use the generated HTTP URL as the callbackUrl value for the [Upload-Video](https://api-portal.videoindexer.ai/api-details#api=Operations&operation=Upload-Video), the callback URL will be called at the end of the video indexing process and will include the video id as a query parameter. __Note:__ to test the flow, you can retrieve manually a video id and set it as a parameter, the id can be retrieved from the video page in Video Indexer portal.

## Upload Video

This simple LogicApp flow shows how to upload a video file from Azure Storage container to Video Indexer and configure a callback URL that will be triggered at the end of the video indexeing process.

Configure the flow:

- videoName: this value will be used as the name of the video in Video Indexer.
- videoURL: the URL where the video is stored, we recommend to use SAS token and not a public URL.
- callbackURL: this URL will be triggered at the end of the video indexing process, the id of the video will be automaticly added as a query parameter.
